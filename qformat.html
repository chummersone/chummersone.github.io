<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="description" content="Convert between floating-point values and their Qm.n fixed-point integer representations, and calculate the representation error.">
        <meta name="keywords" content="q-fomat, fixed-point, floating-point, convert, calculate">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Q-format Converter</title>
        <meta property="og:title" content="Q-format Converter" />
        <meta property="og:url" content="https://chummersone.github.io/qformat.html" />
        <meta property="og:locale" content="en_GB" />
        <meta property="og:description" content="Convert between floating-point and Qm.n fixed-point values">
        <meta property="og:site_name" content="chummersone.github.io" />
        <meta property="og:type" content="website" />
        <link rel="stylesheet" href="https://chummersone.github.io/assets/css/style.css?v=f6040d589f1187e6eaa1ec97f2b3af33299fb0ad">
        <style>
            html {
                padding: 10px;
                box-sizing: border-box;
                font-family: sans-serif;
                font-size: 16px;
            }

            html, body, input, fieldset, select, textarea {
                background-color: #222;
            }

            input:disabled, table, tr, th, td, textarea:disabled {
                background-color: #444;
                -webkit-text-fill-color: #bbb;
                color: #bbb;
                opacity: 1; /* required on iOS */
            }

            body {
                font: inherit;
            }

            body, input, select, p, label, th, td, legend, textarea {
                color: #ccc;
            }

            h1 {
                margin: 20px 0;
                font-size: 2em;
            }

            p {
                margin: 15px 0;
                text-align: left;
            }

            fieldset {
                max-width: 420px;
                width: 100%;
                display: inline-block;
                vertical-align: top;
                margin: 2px;
                border-radius: 5px;
                padding: 20px;
            }

            legend + * {
                margin-top: 0;
            }

            legend {
                font-weight: bold;
            }

            div#container {
                display: flex;
                justify-content: center;
                flex-wrap: wrap;
            }

            input[type=text] {
                text-overflow: ellipsis;
            }

            input {
                text-align: right;
            }

            input[type=text].error,
            input[type=number].error,
            select.error,
            textarea.error {
                border-color: darkred;
                background-color: #da8383;
            }

            div.error {
                display: block;
                font-size: smaller;
                color: #da8383;
            }
            
            input[type=text], input[type=number], select, textarea {
                width: 100%;
                padding: 12px;
                border: 1px solid #ccc;
                border-radius: 4px;
                resize: vertical;
            }

            /* Style the label to display next to the inputs */
            label {
                display: inline-block;
                padding-right: 5px;
                text-align: center;
                width: 100%;
                margin: 0px 0;
            }

            label::after {
                content: ':';
            }

            .col {
                margin-top: 6px;
                display: inline-block;
                text-align: center;
            }

            /* Floating column for labels: 25% width */
            .col.w25 {
                width: 30%;
            }

            /* Floating column for inputs: 75% width */
            .col.w75 {
                width: 70%;
            }

            .col.w75.locked::after {
                content: "ðŸ”’";
                position: absolute;
                right: -20px;
                bottom: 12px;
            }

            .control-grp {
                margin: 8px 0;
                width: 100%;
                position: relative;
            }

            /* Clear floats after the columns */
            .control-grp::after {
                content: "";
                display: table;
                clear: both;
            }

            .control-grp .col {
                vertical-align: middle;
            }

            input[type="text"], textarea {
                font-family: monospace;
            }

            table {
                margin: 0 auto;
                border-collapse: collapse;
                border-radius: 4px;
                overflow: hidden;
                width: 100%;
            }

            table#bit-pos, table#bit-pos tbody {
                display: block;
            }

            table#bit-pos tbody tr {
                display: inline-block;
            }

            table#bit-pos tbody tr td, table#bit-pos tbody tr th {
                display: block;
            }

            th, td {
                padding: 5px;
                text-align: right;
            }

            tr:last-of-type td, tr:last-of-type th {
                border-bottom: none;
            }

            td:last-of-type {
                border-right: none;
            }

            /* Responsive layout - when the screen is less than 600px wide, make the two columns stack on top of each other instead of next to each other */
            @media screen and (max-width: 444px) {
                .col.w25, .col.w75 {
                    width: 100%;
                    margin-top: 0;
                }

                table#bit-pos {
                    display: table;
                }

                table#bit-pos tbody {
                    display: table-row-group;
                }

                table#bit-pos tbody tr {
                    display: table-row;
                }

                table#bit-pos tbody tr td, table#bit-pos tbody tr th {
                    display: table-cell;
                }
            }
        </style>
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"
                integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4="
                crossorigin="anonymous">
        </script>
        <script>
            $(function() {

                const numBitsID = '#num_bits';
                const numFracBitsID = '#num_frac_bits';
                const signedID = '#signed';
                const formatID = '#format';
                const integerID = '#integer';
                const floatID = '#float';
                const realFloatID = '#realfloat';
                const floatErrorID = '#floaterror';
                const errorDbID = '#errordb';
                const labelFormatID = '#labelformat';
                const batchIntegerID = '#batch-int';
                const batchFloatID = '#batch-float';

                var oldNumBits = 0;
                var currentNumBits = 0;
                var oldNumBits = 0;
                getFormNumBits();
                var currentNumFracBits = 0;
                getFormNumFracBits();
                var currentSigned = false;
                getFormSigned();
                var currentFormat = 'hex';
                getFormFormat();
                var currentInteger = 0;
                getFormInteger();
                var currentFloat = 0;
                getFormFloat();
                var userChangedFloat = false;
                var userChangedBatchFloat = false;

                $(numBitsID).change(function () {
                    getFormNumBits();
                    update();
                });

                $(numFracBitsID).change(function () {
                    getFormNumFracBits();
                    update();
                });

                $(signedID).change(function () {
                    getFormSigned();
                    if (~userChangedFloat) {
                        getFormInteger();
                    }
                    update();
                });

                $(formatID).change(function () {
                    getFormFormat();
                    update();
                });

                $(integerID).change(function () {
                    userChangedFloat = false;
                    $(integerID).closest('.col.w75').addClass('locked');
                    $(floatID).closest('.col.w75').removeClass('locked');
                    getFormInteger();
                    update();
                });

                $(floatID).change(function () {
                    userChangedFloat = true;
                    $(integerID).closest('.col.w75').removeClass('locked');
                    $(floatID).closest('.col.w75').addClass('locked');
                    getFormFloat();
                    update();
                });

                $(batchFloatID).blur(function () {
                    userChangedBatchFloat = true;
                    recalculateBatch();
                });

                $(batchIntegerID).blur(function () {
                    userChangedBatchFloat = false;
                    recalculateBatch();
                });

                /**
                 * Update the form elements.
                 */
                function update() {
                    updateMinMax();
                    updateBitPositionsTable();
                    recalculate();
                    recalculateBatch();
                }

                /**
                 * Recalculate the form values.
                 */
                function recalculate() {
                    if (userChangedFloat) {
                        currentInteger = float2fixed(currentFloat);
                    } else {
                        currentFloat = fixed2float(currentInteger);
                    }
                    setFormFloat();
                    setFormInteger();
                    var realFloatVal = fixed2float(currentInteger);
                    $(realFloatID).val(realFloatVal.toString());
                    var floatErr = Math.abs(realFloatVal - currentFloat);
                    $(floatErrorID).val(floatErr.toString());
                    $(errorDbID).val(20*Math.log10(floatErr).toFixed(3));
                }

                /**
                 * Recalculate the batch inputs.
                 */
                function recalculateBatch() {
                    var src, dst;
                    if (userChangedBatchFloat) {
                        src = batchFloatID;
                        dst = batchIntegerID;
                    } else {
                        src = batchIntegerID;
                        dst = batchFloatID;
                    }
                    var batchIn = $(src).val();
                    var rem = batchIn;
                    var out = '';
                    do {
                        let val, delim;
                        const re = /([^\s,]*?)([\s,]+)(.*)/imgs;
                        let arr = [...rem.matchAll(re)][0];
                        if (arr) {
                            val = arr[1];
                            delim = arr[2];
                            rem = arr[3];
                        } else {
                            val = rem;
                            delim = '';
                            rem = false;
                        }
                        let strval;
                        if (userChangedBatchFloat) {
                            strval = int2str(float2fixed(parseFloat(val)));
                        } else {
                            strval = fixed2float(str2int(val)).toString();
                        }
                        out += strval + delim;
                    } while (rem);
                    $(dst).val(out);
                }

                /**
                 * Get the word size, in bits, from the DOM form.
                 * @returns The word size in bits.
                 */
                function getFormNumBits() {
                    oldNumBits = currentNumBits;
                    currentNumBits = parseInt($(numBitsID + ' option:selected').val());
                }

                /**
                 * Set the number of bits. This function updates the UI, decrements the number of
                 * fractional bits, if necessary, and updates other form control attributes and
                 * values.
                 */
                function setFormNumBits() {
                    $(numBitsID + ' option:selected').val(currentNumBits.toString());
                    $(numFracBitsID).find('option').remove().end();
                    for (let i = currentNumBits; i >= 0; i--) {
                        $(numFracBitsID).append('<option value="' + i.toString() + '">' + i.toString() + '</option>')
                    }
                    if (currentNumBits < currentNumFracBits) {
                        currentNumFracBits -= (oldNumBits - currentNumBits);
                    }
                    setFormNumFracBits();
                }

                /**
                 * Get the number of fractional bits from the DOM.
                 */
                function getFormNumFracBits() {
                    currentNumFracBits = parseInt($(numFracBitsID).val());
                }

                /**
                 * Set the number of fractional bits. This function updates the UI, and
                 * updates other form controls.
                 */
                function setFormNumFracBits() {
                    $(numFracBitsID).val(currentNumFracBits.toString());
                }

                /**
                 * Determine whether values are signed.
                 */
                function getFormSigned() {
                    currentSigned = $(signedID).prop('checked');
                }

                /**
                 * Update the signed-ness of the calculations.
                 */
                function setFormSigned() {
                    $(signedID).prop('checked', currentSigned);
                }

                /**
                 * Get the integer display format from the DOM.
                 */
                function getFormFormat() {
                    currentFormat = $(formatID + ' option:selected').val();
                }

                /**
                 * Set the form integer display format. Update the form attributes and the UI.
                 */
                function setFormFormat() {
                    $(formatID).val(currentFormat);
                    var maxlength = 0;
                    var floatlabel = '';
                    switch (currentFormat) {
                        case 'hex':
                            maxlength = Math.ceil(currentNumBits / 4);
                            floatlabel = 'hexadecimal';
                            break;
                        case 'bin':
                            maxlength = currentNumBits;
                            floatlabel = 'binary';
                            break;
                        default:
                            maxlength = (2 ** currentNumBits).toString().length + 1;
                            floatlabel = 'decimal';
                    }
                    $(labelFormatID).text(floatlabel);
                    $(integerID).attr('maxlength', maxlength.toString());
                }

                /**
                 * Check that the integer is valid.
                 */
                function checkInteger(val = currentInteger) {
                    if (isNaN(val)) {
                        setError(integerID, 'Parse Error')
                    } else if (val > maxinteger() || val < mininteger()) {
                        setError(integerID, 'Out of Range')
                    } else {
                        clearError(integerID);
                    }
                }

                /**
                 * Get the integer value from the DOM.
                 */
                function getFormInteger() {
                    currentInteger = str2int($(integerID).val());
                    checkInteger();
                }

                /**
                 * Format an integer value.
                 */
                function int2str(val) {
                    var pad = parseInt($(integerID).attr('maxlength'));
                    var intstr = formatInteger(val, pad);
                    return intstr;
                }

                /**
                 * Update the integer displayed in the DOM.
                 */
                function setFormInteger() {
                    checkInteger();
                    var intstr = int2str(currentInteger);
                    $(integerID).val(intstr);
                }

                /**
                 * Check that the float is valid.
                 */
                function checkFloat(val = currentFloat) {
                    if (isNaN(val)) {
                        setError(floatID, 'Parse Error');
                    } else if (val > maxfloat() || val < minfloat()) {
                        setError(floatID, 'Out of Range');
                    } else {
                        clearError(floatID);
                    }
                }

                /**
                 * Get the float value from the DOM.
                 */
                function getFormFloat() {
                    currentFloat = parseFloat($(floatID).val());
                    checkFloat();
                }

                /**
                 * Update the float displayed in the DOM.
                 */
                function setFormFloat() {
                    checkFloat();
                    $(floatID).val(currentFloat.toString());
                }

                /**
                 * Set an error on the form element.
                 */
                function setError(elem, msg) {
                    clearError(elem);

                    $(elem).addClass('error');
                    $(realFloatID).val('');
                    $(floatErrorID).val('');
                    $(elem).siblings('div.error').remove();
                    $(elem).after('<div class="error">' + msg + '</div>');

                    $(realFloatID).val('NaN');
                    $(floatErrorID).val('NaN');
                    $(errorDbID).val('NaN');
                }

                /**
                 * Clear the error on the form element.
                 */
                function clearError(elem) {
                    $(elem).removeClass('error');
                    $(elem).siblings('div.error').remove();
                }

                /**
                 * Calculate the maximum float value for the current Q-format.
                 * @returns The maximum float value.
                 */
                 function maxfloat() {
                    var signCorrection = 0;
                    if (currentSigned) {
                        signCorrection = 1;
                    }
                    return (2 ** (currentNumBits - currentNumFracBits - signCorrection)) - (2 ** -currentNumFracBits);
                }

                /**
                 * Calculate the minimum float value for the current Q-format.
                 * @returns The minimum float value.
                 */
                function minfloat() {
                    var signCorrection = 0;
                    if (currentSigned) {
                        return - (2 ** (currentNumBits - currentNumFracBits - 1));
                    } else {
                        return 0;
                    }
                }

                /**
                 * Calculate the maximum integer value for the current Q-format.
                 * @returns The maximum integer value.
                 */
                 function maxinteger() {
                    var signCorrection = 0;
                    if (currentSigned) {
                        signCorrection = 1;
                    }
                    return (2 ** (currentNumBits - signCorrection)) - 1;
                }

                /**
                 * Calculate the minimum integer value for the current Q-format.
                 * @returns The minimum integer value.
                 */
                function mininteger() {
                    var signCorrection = 0;
                    if (currentSigned) {
                        return - (2 ** (currentNumBits - 1));
                    } else {
                        return 0;
                    }
                }

                /**
                 * Convert a fixed-point integer to its float value.
                 * @param {number} val The fixed-point integer value.
                 */
                 function fixed2float(val) {
                    return val / (2 ** currentNumFracBits);
                }

                /**
                 * Convert a float value to its fixed-point integer representation.
                 * @param {number} val The float value.
                 */
                 function float2fixed(val) {
                    return Math.round(val * (2 ** currentNumFracBits));
                }

                /**
                 * Calculate a bit mask for the current word.
                 * @returns The bit mask.
                 */
                 function wordmask() {
                    if (currentNumBits < 32) {
                        return ((1 << currentNumBits) - 1);
                    } else {
                        return 0xFFFFFFFF;
                    }
                }

                /**
                 * Convert a string to its corresponding integer value.
                 * @param {string} intstr The integer value represented with a string.
                 * @returns The integer value.
                 */
                 function str2int(intstr) {
                    intstr = intstr.toLowerCase();
                    if (intstr.startsWith('0b')) {
                        currentFormat = 'bin';
                        intstr = intstr.substring(2);
                        setFormFormat();
                    } else if (intstr.startsWith('0x')) {
                        currentFormat = 'hex';
                        intstr = intstr.substring(2);
                        setFormFormat();
                    }
                    var base = 0;
                    switch (currentFormat) {
                        case 'hex':
                            base = 16;
                            break;
                        case 'bin':
                            base = 2;
                            break;
                        default:
                            base = 10;
                    }
                    var intval = parseInt(intstr, base);
                    if (!isNaN(intval) && base != 10) {
                        if (currentSigned && ((0x1 << (currentNumBits - 1)) & intval)) {
                            /* insert missing redundant sign bits for 32-bit internal representation */
                            intval = (intval | (~wordmask()));
                        }
                    }
                    return intval;
                }

                /**
                 * Format the integer.
                 * @param {number} val The integer value.
                 */
                 function formatInteger(val, width) {
                    if (!isNaN(val)) {
                        switch (currentFormat) {
                            case 'hex':
                            case 'bin':
                                /* mask out-of-range bits */
                                val = val & wordmask();
                                /* force to unsigned to prevent a negative symbol */
                                val = val >>> 0;
                                break;
                        }
                        var intstr = '';
                        switch (currentFormat) {
                            case 'hex':
                                intstr = val.toString(16).padStart(width, '0');
                                break;
                            case 'bin':
                                intstr = val.toString(2).padStart(width, '0');
                                break;
                            default:
                                intstr = val.toString();
                        }
                    } else {
                        intstr = NaN;
                    }
                    return intstr;
                }

                /**
                 * Update the displayed min and max float values.
                 */
                function updateMinMax() {
                    setFormFormat();
                    setFormNumBits();
                    $('input#maxfloat').val(maxfloat().toString());
                    $('input#minfloat').val(minfloat().toString());
                }

                /**
                 * Update the bit positions table.
                 */
                function updateBitPositionsTable() {

                    function getMidway($sel) {
                        var midway = Math.floor($sel.length / 2);
                        return midway;
                    }

                    function getBitPosition($sel, index) {
                        var bitPosition = 0;
                        var midway = getMidway($sel);
                        if (index >= 0 && index < midway) {
                            bitPosition = currentNumBits - index - 1;
                        } else {
                            bitPosition = currentNumBits - index - 1 - (currentNumBits - $sel.length);
                        }
                        return bitPosition;
                    }

                    var $bitPosSelection = $('table#bit-pos td:nth-of-type(1)');
                    $bitPosSelection.each(function (index) {
                        if (index != getMidway($bitPosSelection)) {
                            var bitPosition = getBitPosition($bitPosSelection, index);
                            $(this).text(bitPosition.toString());
                        } else {
                            $(this).html('&hellip;');
                        }
                    });

                    var $bitValuesSelection = $('table#bit-pos td:nth-of-type(2)');
                    $bitValuesSelection.each(function (index) {
                        var bitPosition = getBitPosition($bitValuesSelection, index);
                        power = (bitPosition - currentNumFracBits).toString();
                        if (index != getMidway($bitValuesSelection)) {
                            var content = "2<sup>" + power.replace("-", "&minus;") + "</sup>";
                            if (index == 0 && currentSigned) {
                                content = "&minus;" + content;
                            }
                            $(this).html(content);
                        }else {
                            $(this).html('&hellip;');
                        }
                    });
                }

                update();

            });
        </script>
    </head>

    <body>
        <h1>Q-format Converter</h1>

        <p>
            Convert between floating-point values and their <em>Qm.n</em> fixed-point integer representations, and calculate the representation error.
        </p>

        <div id="container">

            <fieldset>
                <legend>Q-Format Settings</legend>

                <p>Choose your conversion options.</p>

                <div class="control-grp">
                    <div class="col w25">
                        <label for="num_bits">Word size in bits (<em>m+n</em>)</label>
                    </div><!--
                    ---><div class="col w75">
                        <select id="num_bits">
                            <option value="16">16</option>
                            <option value="24" selected>24</option>
                            <option value="32">32</option>
                        </select>
                    </div>
                </div>

                <div class="control-grp">
                    <div class="col w25">
                        <label for="num_frac_bits">Fractional bits (<em>n</em>)</label>
                    </div><!--
                ---><div class="col w75">
                        <select id="num_frac_bits">
                            <option value="23" selected>23</option>
                        </select>
                    </div>
                </div>

                <div class="control-grp">
                    <div class="col w25">
                        <label for="signed">Signed?</label>
                    </div><!--
                    ---><div class="col w75">
                        <input id="signed" type="checkbox" checked>
                    </div>
                </div>

                <div class="control-grp">
                    <div class="col w25">
                        <label for="format">Integer format</label>
                    </div><!--
                    ---><div class="col w75">
                        <select id="format">
                            <option value="hex" selected>Hexadecimal</option>
                            <option value="dec">Decimal</option>
                            <option value="bin">Binary</option>
                        </select>
                    </div>
                </div>

                <div class="control-grp">
                    <div class="col w25">
                        <label for="maxfloat">Maximum float value</label>
                    </div><!--
                    ---><div class="col w75">
                        <input id="maxfloat" type="text" value="0" disabled>
                    </div>
                </div>

                <div class="control-grp">
                    <div class="col w25">
                        <label for="minfloat">Minimum float value</label>
                    </div><!--
                    ---><div class="col w75">
                        <input id="minfloat" type="text" value="0" disabled>
                    </div>
                </div>

                <div class="control-grp">
                    <label>Bit positions and values</label>

                    <table id="bit-pos">
                        <tr>
                            <th>Bit Position</th>
                            <th>Bit Value</th>
                        </tr>
                        <tr>
                            <td></td>
                            <td></td>
                        </tr>
                        <tr>
                            <td></td>
                            <td></td>
                        </tr>
                        <tr>
                            <td></td>
                            <td></td>
                        </tr>
                        <tr>
                            <td></td>
                            <td></td>
                        </tr>
                        <tr>
                            <td></td>
                            <td></td>
                        </tr>
                        <tr>
                            <td></td>
                            <td></td>
                        </tr>
                        <tr>
                            <td></td>
                            <td></td>
                        </tr>
                    </table>
                </div>
            </fieldset><!--

        ---><fieldset>
                <legend>Convert</legend>

                <p>Type an integer or float in the boxes below. Click or tab away to update.</p>

                <div class="control-grp">
                    <div class="col w25">
                        <label for="integer">Integer (<span id="labelformat">hexadecimal</span>)</label>
                    </div><!--
                    ---><div class="col w75">
                        <input id="integer" type="text" value="0" maxlength="6">
                    </div>
                </div>

                <div class="control-grp">
                    <div class="col w25">
                        <label for="float">Float</label>
                    </div><!--
                    ---><div class="col w75">
                        <input id="float" type="text" value="0">
                    </div>
                </div>

                <div class="control-grp">
                    <div class="col w25">
                        <label for="realfloat">Fixed-point value</label>
                    </div><!--
                    ---><div class="col w75">
                        <input id="realfloat" type="text" value="0" disabled>
                    </div>
                </div>

                <div class="control-grp">
                    <div class="col w25">
                        <label for="floaterror">Representation error</label>
                    </div><!--
                    ---><div class="col w75">
                        <input id="floaterror" type="text" value="0" disabled>
                    </div>
                </div>

                <div class="control-grp">
                    <div class="col w25">
                        <label for="errordb">Representation error (dB)</label>
                    </div><!--
                    ---><div class="col w75">
                        <input id="errordb" type="text" value="0" disabled>
                    </div>
                </div>
            </fieldset><!--

        ---><fieldset>
                <legend>Batch Convert</legend>

                <p>Type integers or floats in the boxes below separated by commas, spaces or new lines. Click or tab away to update.</p>

                <label for="batch-int">Integers</label>
                <textarea id="batch-int" rows="6"></textarea>

                <label for="batch-float">Floats</label>
                <textarea id="batch-float" rows="6"></textarea>

            </fieldset>

        </div>

    </body>

</html>
